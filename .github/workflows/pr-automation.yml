name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: npm run lint
        continue-on-error: true

      - name: Run Prettier formatting check
        id: prettier
        run: npx prettier --check .
        continue-on-error: true

      - name: Post Code Quality Report
        uses: actions/github-script@v7
        with:
          script: |
            const eslintOutcome = "${{ steps.eslint.outcome }}";
            const prettierOutcome = "${{ steps.prettier.outcome }}";
            
            let comment = "## Code Quality Report\n\n";
            comment += "### ESLint\n";
            comment += eslintOutcome === 'success' ? "✅ No ESLint errors found\n" : "❌ ESLint errors detected (see job logs for details)\n\n";
            comment += "### Prettier\n";
            comment += prettierOutcome === 'success' ? "✅ All files are properly formatted\n" : "❌ Formatting issues found (run `prettier --write .` to fix)\n";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail job if code quality checks failed
        if: steps.eslint.outcome != 'success' || steps.prettier.outcome != 'success'
        run: exit 1

  testing-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run test suite
        id: test
        run: npm test
        continue-on-error: true

      - name: Generate coverage summary
        id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            cat coverage/coverage-summary.json | jq '.total | "Lines: \(.lines.pct)%, Statements: \(.statements.pct)%, Functions: \(.functions.pct)%, Branches: \(.branches.pct)%"' > coverage-summary.txt
          else
            echo "No coverage report found" > coverage-summary.txt
          fi
        continue-on-error: true

      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        with:
          script: |
            const testOutcome = "${{ steps.test.outcome }}";
            const coverageSummary = fs.readFileSync('coverage-summary.txt', 'utf8').trim();
            
            let comment = "## Test Coverage Report\n\n";
            comment += testOutcome === 'success' ? "✅ Test suite passed\n\n" : "❌ Test suite failed (see job logs for details)\n\n";
            comment += "### Coverage Summary\n";
            comment += coverageSummary.replace(/"/g, '');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.test.outcome != 'success'
        run: exit 1

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run dependency vulnerability check
        id: dependency-check
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Scan for secrets in code changes
        id: secret-scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified
        continue-on-error: true

      - name: Post Security Scan Report
        uses: actions/github-script@v7
        with:
          script: |
            const depCheckOutcome = "${{ steps.dependency-check.outcome }}";
            const secretScanOutcome = "${{ steps.secret-scan.outcome }}";
            
            let comment = "## Security Scan Report\n\n";
            comment += "### Dependencies Vulnerability Check\n";
            comment += depCheckOutcome === 'success' ? "✅ No moderate or higher vulnerabilities found\n" : "❌ Vulnerabilities detected (see job logs for details)\n\n";
            comment += "### Secret Scan\n";
            comment += secretScanOutcome === 'success' ? "✅ No secrets found in code changes\n" : "❌ Secrets detected (see job logs for details)\n";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail job if security checks failed
        if: steps.dependency-check.outcome != 'success' || steps.secret-scan.outcome != 'success'
        run: exit 1

  build-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: npm run build
        continue-on-error: true

      - name: Validate endpoints
        id: validate-endpoints
        run: |
          if [ -f dist/index.js ]; then
            node dist/index.js &
            sleep 5
            curl -f http://localhost:3000/health || exit 1
          else
            echo "Build artifact not found, skipping endpoint validation"
          fi
        continue-on-error: true

      - name: Post Build Validation Report
        uses: actions/github-script@v7
        with:
          script: |
            const buildOutcome = "${{ steps.build.outcome }}";
            const endpointOutcome = "${{ steps.validate-endpoints.outcome }}";
            
            let comment = "## Build Validation\n\n";
            comment += buildOutcome === 'success' ? "✅ Application built successfully\n" : "❌ Build failed (see job logs for details)\n\n";
            comment += "### Endpoint Validation\n";
            comment += endpointOutcome === 'success' ? "✅ All endpoints are accessible\n" : "❌ Endpoint validation failed (see job logs for details)\n";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

      - name: Fail job if build/validation failed
        if: steps.build.outcome != 'success' || steps.validate-endpoints.outcome != 'success'
        run: exit 1